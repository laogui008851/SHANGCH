import{P as $,ag as L,a9 as q,d as V,U as Q,bp as X,b as i,I as F,Y,aI as D,a4 as Z,aR as H,Q as z,aa as A,S as I,a2 as P,bf as J,r as K,a$ as W,ae as ee,ab as ae,a8 as ne,aP as k,ai as le,l as te,Z as ie}from"./index-754777e9.js";import{I as re}from"./index-dce3f47a.js";import{I as oe}from"./index-7e9868ca.js";const[se,r,ce]=$("uploader");function U(e,n){return new Promise(o=>{if(n==="file"){o();return}const c=new FileReader;c.onload=v=>{o(v.target.result)},n==="dataUrl"?c.readAsDataURL(e):n==="text"&&c.readAsText(e)})}function O(e,n){return L(e).some(o=>o.file?q(n)?n(o.file):o.file.size>n:!1)}function ue(e,n){const o=[],c=[];return e.forEach(v=>{O(v,n)?c.push(v):o.push(v)}),{valid:o,invalid:c}}const de=/\.(jpeg|jpg|gif|png|svg|webp|jfif|bmp|dpg)/i,fe=e=>de.test(e);function j(e){return e.isImage?!0:e.file&&e.file.type?e.file.type.indexOf("image")===0:e.url?fe(e.url):typeof e.content=="string"?e.content.indexOf("data:image")===0:!1}var ve=V({props:{name:Q,item:X(Object),index:Number,imageFit:String,lazyLoad:Boolean,deletable:Boolean,previewSize:[Number,String,Array],beforeDelete:Function},emits:["delete","preview"],setup(e,{emit:n,slots:o}){const c=()=>{const{status:l,message:u}=e.item;if(l==="uploading"||l==="failed"){const w=l==="failed"?i(F,{name:"close",class:r("mask-icon")},null):i(Y,{class:r("loading")},null),f=Z(u)&&u!=="";return i("div",{class:r("mask")},[w,f&&i("div",{class:r("mask-message")},[u])])}},v=l=>{const{name:u,item:w,index:f,beforeDelete:x}=e;l.stopPropagation(),H(x,{args:[w,{name:u,index:f}],done:()=>n("delete")})},m=()=>n("preview"),b=()=>{if(e.deletable&&e.item.status!=="uploading"){const l=o["preview-delete"];return i("div",{role:"button",class:r("preview-delete",{shadow:!l}),tabindex:0,"aria-label":ce("delete"),onClick:v},[l?l():i(F,{name:"cross",class:r("preview-delete-icon")},null)])}},y=()=>{if(o["preview-cover"]){const{index:l,item:u}=e;return i("div",{class:r("preview-cover")},[o["preview-cover"](z({index:l},u))])}},h=()=>{const{item:l,lazyLoad:u,imageFit:w,previewSize:f}=e;return j(l)?i(oe,{fit:w,src:l.content||l.url,class:r("preview-image"),width:Array.isArray(f)?f[0]:f,height:Array.isArray(f)?f[1]:f,lazyLoad:u,onClick:m},{default:y}):i("div",{class:r("file"),style:D(e.previewSize)},[i(F,{class:r("file-icon"),name:"description"},null),i("div",{class:[r("file-name"),"van-ellipsis"]},[l.file?l.file.name:l.url]),y()])};return()=>i("div",{class:r("preview")},[h(),c(),b()])}});const me={name:A(""),accept:I("image/*"),capture:String,multiple:Boolean,disabled:Boolean,readonly:Boolean,lazyLoad:Boolean,maxCount:A(1/0),imageFit:I("cover"),resultType:I("dataUrl"),uploadIcon:I("photograph"),uploadText:String,deletable:P,afterRead:Function,showUpload:P,modelValue:J(),beforeRead:Function,beforeDelete:Function,previewSize:[Number,String,Array],previewImage:P,previewOptions:Object,previewFullImage:P,maxSize:{type:[Number,String,Function],default:1/0}};var ge=V({name:se,props:me,emits:["delete","oversize","click-upload","close-preview","click-preview","update:modelValue"],setup(e,{emit:n,slots:o}){const c=K(),v=[],m=(a=e.modelValue.length)=>({name:e.name,index:a}),b=()=>{c.value&&(c.value.value="")},y=a=>{if(b(),O(a,e.maxSize))if(Array.isArray(a)){const t=ue(a,e.maxSize);if(a=t.valid,n("oversize",t.invalid,m()),!a.length)return}else{n("oversize",a,m());return}a=te(a),n("update:modelValue",[...e.modelValue,...L(a)]),e.afterRead&&e.afterRead(a,m())},h=a=>{const{maxCount:t,modelValue:d,resultType:s}=e;if(Array.isArray(a)){const g=+t-d.length;a.length>g&&(a=a.slice(0,g)),Promise.all(a.map(p=>U(p,s))).then(p=>{const _=a.map((G,R)=>{const S={file:G,status:"",message:""};return p[R]&&(S.content=p[R]),S});y(_)})}else U(a,s).then(g=>{const p={file:a,status:"",message:""};g&&(p.content=g),y(p)})},l=a=>{const{files:t}=a.target;if(e.disabled||!t||!t.length)return;const d=t.length===1?t[0]:[].slice.call(t);if(e.beforeRead){const s=e.beforeRead(d,m());if(!s){b();return}if(ne(s)){s.then(g=>{h(g||d)}).catch(b);return}}h(d)};let u;const w=()=>n("close-preview"),f=a=>{if(e.previewFullImage){const t=e.modelValue.filter(j),d=t.map(s=>(s.file&&!s.url&&s.status!=="failed"&&(s.url=URL.createObjectURL(s.file),v.push(s.url)),s.url)).filter(Boolean);u=re(z({images:d,startPosition:t.indexOf(a),onClose:w},e.previewOptions))}},x=()=>{u&&u.close()},B=(a,t)=>{const d=e.modelValue.slice(0);d.splice(t,1),n("update:modelValue",d),n("delete",a,m(t))},N=(a,t)=>{const d=["imageFit","deletable","previewSize","beforeDelete"],s=z(k(e,d),k(a,d,!0));return i(ve,le({item:a,index:t,onClick:()=>n("click-preview",a,m(t)),onDelete:()=>B(a,t),onPreview:()=>f(a)},k(e,["name","lazyLoad"]),s),k(o,["preview-cover","preview-delete"]))},E=()=>{if(e.previewImage)return e.modelValue.map(N)},C=a=>n("click-upload",a),M=()=>{if(e.modelValue.length>=e.maxCount||!e.showUpload)return;const a=e.readonly?null:i("input",{ref:c,type:"file",class:r("input"),accept:e.accept,capture:e.capture,multiple:e.multiple,disabled:e.disabled,onChange:l},null);return o.default?i("div",{class:r("input-wrapper"),onClick:C},[o.default(),a]):i("div",{class:r("upload",{readonly:e.readonly}),style:D(e.previewSize),onClick:C},[i(F,{name:e.uploadIcon,class:r("upload-icon")},null),e.uploadText&&i("span",{class:r("upload-text")},[e.uploadText]),a])},T=()=>{c.value&&!e.disabled&&c.value.click()};return W(()=>{v.forEach(a=>URL.revokeObjectURL(a))}),ee({chooseFile:T,closeImagePreview:x}),ae.useCustomFieldValue(()=>e.modelValue),()=>i("div",{class:r()},[i("div",{class:r("wrapper",{disabled:e.disabled})},[E(),M()])])}});const ye=ie(ge);export{ye as U};
