import{Q,ae as V,a7 as $,d as L,V as q,bk as H,b as i,I as F,Z as X,aH as D,a2 as Z,aQ as J,R as z,a8 as S,U as I,a0 as k,bs as K,r as W,a_ as Y,ac as ee,a9 as ae,a6 as ne,aO as P,ag as te,p as le,$ as ie}from"./index-9e7fbb1d.js";import{I as re}from"./index-514928b3.js";import{I as oe}from"./index-7160bc73.js";const[se,r,ce]=Q("uploader");function U(e,n){return new Promise(o=>{if(n==="file"){o();return}const c=new FileReader;c.onload=v=>{o(v.target.result)},n==="dataUrl"?c.readAsDataURL(e):n==="text"&&c.readAsText(e)})}function O(e,n){return V(e).some(o=>o.file?$(n)?n(o.file):o.file.size>n:!1)}function ue(e,n){const o=[],c=[];return e.forEach(v=>{O(v,n)?c.push(v):o.push(v)}),{valid:o,invalid:c}}const de=/\.(jpeg|jpg|gif|png|svg|webp|jfif|bmp|dpg)/i,fe=e=>de.test(e);function j(e){return e.isImage?!0:e.file&&e.file.type?e.file.type.indexOf("image")===0:e.url?fe(e.url):typeof e.content=="string"?e.content.indexOf("data:image")===0:!1}var ve=L({props:{name:q,item:H(Object),index:Number,imageFit:String,lazyLoad:Boolean,deletable:Boolean,previewSize:[Number,String,Array],beforeDelete:Function},emits:["delete","preview"],setup(e,{emit:n,slots:o}){const c=()=>{const{status:t,message:u}=e.item;if(t==="uploading"||t==="failed"){const w=t==="failed"?i(F,{name:"close",class:r("mask-icon")},null):i(X,{class:r("loading")},null),f=Z(u)&&u!=="";return i("div",{class:r("mask")},[w,f&&i("div",{class:r("mask-message")},[u])])}},v=t=>{const{name:u,item:w,index:f,beforeDelete:x}=e;t.stopPropagation(),J(x,{args:[w,{name:u,index:f}],done:()=>n("delete")})},m=()=>n("preview"),b=()=>{if(e.deletable&&e.item.status!=="uploading"){const t=o["preview-delete"];return i("div",{role:"button",class:r("preview-delete",{shadow:!t}),tabindex:0,"aria-label":ce("delete"),onClick:v},[t?t():i(F,{name:"cross",class:r("preview-delete-icon")},null)])}},y=()=>{if(o["preview-cover"]){const{index:t,item:u}=e;return i("div",{class:r("preview-cover")},[o["preview-cover"](z({index:t},u))])}},h=()=>{const{item:t,lazyLoad:u,imageFit:w,previewSize:f}=e;return j(t)?i(oe,{fit:w,src:t.content||t.url,class:r("preview-image"),width:Array.isArray(f)?f[0]:f,height:Array.isArray(f)?f[1]:f,lazyLoad:u,onClick:m},{default:y}):i("div",{class:r("file"),style:D(e.previewSize)},[i(F,{class:r("file-icon"),name:"description"},null),i("div",{class:[r("file-name"),"van-ellipsis"]},[t.file?t.file.name:t.url]),y()])};return()=>i("div",{class:r("preview")},[h(),c(),b()])}});const me={name:S(""),accept:I("image/*"),capture:String,multiple:Boolean,disabled:Boolean,readonly:Boolean,lazyLoad:Boolean,maxCount:S(1/0),imageFit:I("cover"),resultType:I("dataUrl"),uploadIcon:I("photograph"),uploadText:String,deletable:k,afterRead:Function,showUpload:k,modelValue:K(),beforeRead:Function,beforeDelete:Function,previewSize:[Number,String,Array],previewImage:k,previewOptions:Object,previewFullImage:k,maxSize:{type:[Number,String,Function],default:1/0}};var ge=L({name:se,props:me,emits:["delete","oversize","click-upload","close-preview","click-preview","update:modelValue"],setup(e,{emit:n,slots:o}){const c=W(),v=[],m=(a=e.modelValue.length)=>({name:e.name,index:a}),b=()=>{c.value&&(c.value.value="")},y=a=>{if(b(),O(a,e.maxSize))if(Array.isArray(a)){const l=ue(a,e.maxSize);if(a=l.valid,n("oversize",l.invalid,m()),!a.length)return}else{n("oversize",a,m());return}a=le(a),n("update:modelValue",[...e.modelValue,...V(a)]),e.afterRead&&e.afterRead(a,m())},h=a=>{const{maxCount:l,modelValue:d,resultType:s}=e;if(Array.isArray(a)){const g=+l-d.length;a.length>g&&(a=a.slice(0,g)),Promise.all(a.map(p=>U(p,s))).then(p=>{const T=a.map((G,R)=>{const A={file:G,status:"",message:""};return p[R]&&(A.content=p[R]),A});y(T)})}else U(a,s).then(g=>{const p={file:a,status:"",message:""};g&&(p.content=g),y(p)})},t=a=>{const{files:l}=a.target;if(e.disabled||!l||!l.length)return;const d=l.length===1?l[0]:[].slice.call(l);if(e.beforeRead){const s=e.beforeRead(d,m());if(!s){b();return}if(ne(s)){s.then(g=>{h(g||d)}).catch(b);return}}h(d)};let u;const w=()=>n("close-preview"),f=a=>{if(e.previewFullImage){const l=e.modelValue.filter(j),d=l.map(s=>(s.file&&!s.url&&s.status!=="failed"&&(s.url=URL.createObjectURL(s.file),v.push(s.url)),s.url)).filter(Boolean);u=re(z({images:d,startPosition:l.indexOf(a),onClose:w},e.previewOptions))}},x=()=>{u&&u.close()},B=(a,l)=>{const d=e.modelValue.slice(0);d.splice(l,1),n("update:modelValue",d),n("delete",a,m(l))},N=(a,l)=>{const d=["imageFit","deletable","previewSize","beforeDelete"],s=z(P(e,d),P(a,d,!0));return i(ve,te({item:a,index:l,onClick:()=>n("click-preview",a,m(l)),onDelete:()=>B(a,l),onPreview:()=>f(a)},P(e,["name","lazyLoad"]),s),P(o,["preview-cover","preview-delete"]))},E=()=>{if(e.previewImage)return e.modelValue.map(N)},C=a=>n("click-upload",a),_=()=>{if(e.modelValue.length>=e.maxCount||!e.showUpload)return;const a=e.readonly?null:i("input",{ref:c,type:"file",class:r("input"),accept:e.accept,capture:e.capture,multiple:e.multiple,disabled:e.disabled,onChange:t},null);return o.default?i("div",{class:r("input-wrapper"),onClick:C},[o.default(),a]):i("div",{class:r("upload",{readonly:e.readonly}),style:D(e.previewSize),onClick:C},[i(F,{name:e.uploadIcon,class:r("upload-icon")},null),e.uploadText&&i("span",{class:r("upload-text")},[e.uploadText]),a])},M=()=>{c.value&&!e.disabled&&c.value.click()};return Y(()=>{v.forEach(a=>URL.revokeObjectURL(a))}),ee({chooseFile:M,closeImagePreview:x}),ae.useCustomFieldValue(()=>e.modelValue),()=>i("div",{class:r()},[i("div",{class:r("wrapper",{disabled:e.disabled})},[E(),_()])])}});const ye=ie(ge);export{ye as U};
