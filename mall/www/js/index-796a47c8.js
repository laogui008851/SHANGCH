import{z as K,ae as U,a4 as $,d as V,D as q,be as X,e as i,I as F,L as Y,aF as D,$ as Z,bh as H,A as C,a5 as S,C as I,Y as P,bo as J,r as Q,aO as W,a9 as ee,bK as ae,a3 as ne,aZ as k,ag as le,l as te,K as ie}from"./index-9fb53779.js";import{I as re}from"./index-4a76e6fd.js";import{I as oe}from"./index-4c40d7c7.js";const[se,r,ce]=K("uploader");function L(e,n){return new Promise(o=>{if(n==="file"){o();return}const c=new FileReader;c.onload=v=>{o(v.target.result)},n==="dataUrl"?c.readAsDataURL(e):n==="text"&&c.readAsText(e)})}function O(e,n){return U(e).some(o=>o.file?$(n)?n(o.file):o.file.size>n:!1)}function ue(e,n){const o=[],c=[];return e.forEach(v=>{O(v,n)?c.push(v):o.push(v)}),{valid:o,invalid:c}}const de=/\.(jpeg|jpg|gif|png|svg|webp|jfif|bmp|dpg)/i,fe=e=>de.test(e);function B(e){return e.isImage?!0:e.file&&e.file.type?e.file.type.indexOf("image")===0:e.url?fe(e.url):typeof e.content=="string"?e.content.indexOf("data:image")===0:!1}var ve=V({props:{name:q,item:X(Object),index:Number,imageFit:String,lazyLoad:Boolean,deletable:Boolean,previewSize:[Number,String,Array],beforeDelete:Function},emits:["delete","preview"],setup(e,{emit:n,slots:o}){const c=()=>{const{status:l,message:u}=e.item;if(l==="uploading"||l==="failed"){const w=l==="failed"?i(F,{name:"close",class:r("mask-icon")},null):i(Y,{class:r("loading")},null),f=Z(u)&&u!=="";return i("div",{class:r("mask")},[w,f&&i("div",{class:r("mask-message")},[u])])}},v=l=>{const{name:u,item:w,index:f,beforeDelete:z}=e;l.stopPropagation(),H(z,{args:[w,{name:u,index:f}],done:()=>n("delete")})},m=()=>n("preview"),b=()=>{if(e.deletable&&e.item.status!=="uploading"){const l=o["preview-delete"];return i("div",{role:"button",class:r("preview-delete",{shadow:!l}),tabindex:0,"aria-label":ce("delete"),onClick:v},[l?l():i(F,{name:"cross",class:r("preview-delete-icon")},null)])}},h=()=>{if(o["preview-cover"]){const{index:l,item:u}=e;return i("div",{class:r("preview-cover")},[o["preview-cover"](C({index:l},u))])}},y=()=>{const{item:l,lazyLoad:u,imageFit:w,previewSize:f}=e;return B(l)?i(oe,{fit:w,src:l.content||l.url,class:r("preview-image"),width:Array.isArray(f)?f[0]:f,height:Array.isArray(f)?f[1]:f,lazyLoad:u,onClick:m},{default:h}):i("div",{class:r("file"),style:D(e.previewSize)},[i(F,{class:r("file-icon"),name:"description"},null),i("div",{class:[r("file-name"),"van-ellipsis"]},[l.file?l.file.name:l.url]),h()])};return()=>i("div",{class:r("preview")},[y(),c(),b()])}});const me={name:S(""),accept:I("image/*"),capture:String,multiple:Boolean,disabled:Boolean,readonly:Boolean,lazyLoad:Boolean,maxCount:S(1/0),imageFit:I("cover"),resultType:I("dataUrl"),uploadIcon:I("photograph"),uploadText:String,deletable:P,afterRead:Function,showUpload:P,modelValue:J(),beforeRead:Function,beforeDelete:Function,previewSize:[Number,String,Array],previewImage:P,previewOptions:Object,previewFullImage:P,maxSize:{type:[Number,String,Function],default:1/0}};var ge=V({name:se,props:me,emits:["delete","oversize","click-upload","close-preview","click-preview","update:modelValue"],setup(e,{emit:n,slots:o}){const c=Q(),v=[],m=(a=e.modelValue.length)=>({name:e.name,index:a}),b=()=>{c.value&&(c.value.value="")},h=a=>{if(b(),O(a,e.maxSize))if(Array.isArray(a)){const t=ue(a,e.maxSize);if(a=t.valid,n("oversize",t.invalid,m()),!a.length)return}else{n("oversize",a,m());return}a=te(a),n("update:modelValue",[...e.modelValue,...U(a)]),e.afterRead&&e.afterRead(a,m())},y=a=>{const{maxCount:t,modelValue:d,resultType:s}=e;if(Array.isArray(a)){const g=+t-d.length;a.length>g&&(a=a.slice(0,g)),Promise.all(a.map(p=>L(p,s))).then(p=>{const _=a.map((G,A)=>{const R={file:G,status:"",message:""};return p[A]&&(R.content=p[A]),R});h(_)})}else L(a,s).then(g=>{const p={file:a,status:"",message:""};g&&(p.content=g),h(p)})},l=a=>{const{files:t}=a.target;if(e.disabled||!t||!t.length)return;const d=t.length===1?t[0]:[].slice.call(t);if(e.beforeRead){const s=e.beforeRead(d,m());if(!s){b();return}if(ne(s)){s.then(g=>{y(g||d)}).catch(b);return}}y(d)};let u;const w=()=>n("close-preview"),f=a=>{if(e.previewFullImage){const t=e.modelValue.filter(B),d=t.map(s=>(s.file&&!s.url&&s.status!=="failed"&&(s.url=URL.createObjectURL(s.file),v.push(s.url)),s.url)).filter(Boolean);u=re(C({images:d,startPosition:t.indexOf(a),onClose:w},e.previewOptions))}},z=()=>{u&&u.close()},j=(a,t)=>{const d=e.modelValue.slice(0);d.splice(t,1),n("update:modelValue",d),n("delete",a,m(t))},N=(a,t)=>{const d=["imageFit","deletable","previewSize","beforeDelete"],s=C(k(e,d),k(a,d,!0));return i(ve,le({item:a,index:t,onClick:()=>n("click-preview",a,m(t)),onDelete:()=>j(a,t),onPreview:()=>f(a)},k(e,["name","lazyLoad"]),s),k(o,["preview-cover","preview-delete"]))},E=()=>{if(e.previewImage)return e.modelValue.map(N)},x=a=>n("click-upload",a),M=()=>{if(e.modelValue.length>=e.maxCount||!e.showUpload)return;const a=e.readonly?null:i("input",{ref:c,type:"file",class:r("input"),accept:e.accept,capture:e.capture,multiple:e.multiple,disabled:e.disabled,onChange:l},null);return o.default?i("div",{class:r("input-wrapper"),onClick:x},[o.default(),a]):i("div",{class:r("upload",{readonly:e.readonly}),style:D(e.previewSize),onClick:x},[i(F,{name:e.uploadIcon,class:r("upload-icon")},null),e.uploadText&&i("span",{class:r("upload-text")},[e.uploadText]),a])},T=()=>{c.value&&!e.disabled&&c.value.click()};return W(()=>{v.forEach(a=>URL.revokeObjectURL(a))}),ee({chooseFile:T,closeImagePreview:z}),ae(()=>e.modelValue),()=>i("div",{class:r()},[i("div",{class:r("wrapper",{disabled:e.disabled})},[E(),M()])])}});const he=ie(ge);export{he as U};
